<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Map with Custom Markers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 40px; bottom: 0; width: 100%; }
        #controls {
            position: absolute;
            top: 50px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        #controls button {
            margin: 5px 0;
            font-size: 14px;
            font-weight: bold;
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            background-color: #ff4800;
            color: white;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        #controls button:hover {
            background-color: #5400b3;
        }

        .mapboxgl-popup {
            font-size: 16px;
        }

        .mapboxgl-popup h3 {
            font-size: 18px;
            font-weight: bold;
        }

        .mapboxgl-popup p {
            font-size: 16px;
        }

        .custom-marker, .placeholder-marker {
            width: 25px;
            height: 25px;
            cursor: pointer;
            background-size: cover;
            background-repeat: no-repeat;
        }

        .combined-marker {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .combined-marker .icon {
            width: 15px;
            height: 15px;
            margin: 2px;
        }
    </style>
</head>
<body>

<div id="controls">
    <button id="show-installed-trackers">Installed Sites with Trackers</button>
    <button id="show-installed-only">Installed Sites Without Trackers</button>
    <button id="show-all">All Sites</button>
</div>

<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuaWVsLWZpbmRydHJhY2tpbmciLCJhIjoiY20yNG52NnA3MGVmbjJqcXV1Z2FtczhubiJ9.y26OUUxKLe2ZP4YUAw1a8Q'; // Replace with your Mapbox token

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-0.2115747, 5.5663486], // Adjust as needed
        zoom: 6
    });

    map.addControl(new mapboxgl.NavigationControl());

    let markers = []; // Array to hold marker references
    let countWithTrackers = 0;
    let countWithoutTrackers = 0;
    let totalUniqueSites = 0;

    // Helper function to determine if a site has a tracker based on trackerIMEI
    function hasTracker(trackerIMEI) {
        return trackerIMEI !== null && trackerIMEI !== 0; // Site has a tracker if trackerIMEI exists and is non-zero
    }

    // Fetch the new unique sites JSON file
    fetch('transformed_Unique.json') // Use the actual JSON filename
        .then(response => response.json())
        .then(data => {
            // Reset counts at the beginning
            countWithTrackers = 0;
            countWithoutTrackers = 0;
            totalUniqueSites = 0;

            // Parse through each site entry
            data.forEach(function (site) {
                const lat = parseFloat(site.lat);
                const lon = parseFloat(site.lon);

                // Ensure valid coordinates
                if (!isNaN(lat) && !isNaN(lon)) {
                    totalUniqueSites++; // Count unique sites

                    // Track whether the site has a tracker based on trackerIMEI
                    if (hasTracker(site.trackerIMEI)) {
                        countWithTrackers++; // Count sites with trackers
                    } else {
                        countWithoutTrackers++; // Count sites without trackers
                    }

                    // Create marker element
                    var el = document.createElement('div');
                    el.className = 'combined-marker'; // Marker with multiple icons

                    // Add icons to marker (both tower and tracker, if applicable)
                    site.icons.forEach(function(iconUrl) {
                        var icon = document.createElement('div');
                        icon.className = 'icon';
                        icon.style.backgroundImage = `url(${iconUrl})`;
                        icon.style.backgroundSize = 'cover';
                        el.appendChild(icon);
                    });
                   
// Create a hover popup
const hoverPopup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false })
                    .setHTML(`
                        <h3>${site.name}</h3>
                        <p>ID: ${site.id}</p>
                        ${site.trackerIMEI ? `<p>IMEI: ${site.trackerIMEI}</p>` : '<p>IMEI: Not available</p>'}
                    `);

                // Add hover functionality
                el.addEventListener('mouseenter', () => {
                    hoverPopup.setLngLat([lon, lat]).addTo(map);
                });

                el.addEventListener('mouseleave', () => {
                    hoverPopup.remove();
                });


                    // Add marker to the map and store reference
                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([lon, lat])
                        .setPopup(new mapboxgl.Popup({ offset: 25 })
                            .setHTML(`
                                <h3>${site.name}</h3>
                                <p>Site ID: ${site.id}</p>
                                <p>Tracker IMEI: ${site.trackerIMEI ? site.trackerIMEI : 'No Tracker'}</p>
                            `))
                        .addTo(map);

                    markers.push({ marker, site }); // Store marker and site
                }
            });

            // Log final counts for debugging
            console.log("Total Unique Sites:", totalUniqueSites);
            console.log("Sites With Trackers:", countWithTrackers);
            console.log("Sites Without Trackers:", countWithoutTrackers);
        })
        .catch(error => console.error('Error loading JSON data:', error));


        
    // Filtering functionality

    // Show sites with trackers
    document.getElementById('show-installed-trackers').onclick = function () {
        markers.forEach(({ marker, site }) => {
            if (hasTracker(site.trackerIMEI)) { // Show only sites with trackers
                marker.addTo(map);
            } else {
                marker.remove();
            }
        });
    };

    // Show sites without trackers
    document.getElementById('show-installed-only').onclick = function () {
        markers.forEach(({ marker, site }) => {
            if (!hasTracker(site.trackerIMEI)) { // Show only sites without trackers
                marker.addTo(map);
            } else {
                marker.remove();
            }
        });
    };

    // Show all sites
    document.getElementById('show-all').onclick = function () {
        markers.forEach(({ marker }) => {
            marker.addTo(map);
        });
    };

</script>

</body>
</html>
